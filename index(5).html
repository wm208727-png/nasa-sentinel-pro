<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Sentinel Pro | Integrated Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --nasa-blue: #0b3d91;
            --nasa-red: #fc3d21;
            --bg-dark: #010409;
            --neon-blue: #00d4ff;
            --sidebar-bg: #0d1117;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: white; overflow: hidden; }
        
        .dashboard-container { display: grid; grid-template-columns: 350px 1fr; height: 100vh; }

        /* Sidebar Styling */
        .sidebar { background: var(--sidebar-bg); border-right: 1px solid #30363d; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1001; overflow-y: auto; }
        
        /* Map Container */
        #map { width: 100%; height: 100%; background: #000; z-index: 1; }

        /* Overlay Controls */
        .search-box { position: absolute; top: 20px; left: 370px; z-index: 1000; background: rgba(13, 17, 23, 0.9); padding: 8px; border-radius: 12px; border: 1px solid var(--nasa-blue); display: flex; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .layer-control { position: absolute; top: 80px; left: 370px; z-index: 1000; background: rgba(13, 17, 23, 0.9); padding: 10px; border-radius: 8px; border: 1px solid var(--neon-blue); display: flex; gap: 10px; }
        
        input { background: transparent; border: none; color: white; outline: none; width: 220px; padding-left: 5px; }
        button { background: var(--nasa-blue); border: none; color: white; padding: 8px 15px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--neon-blue); color: black; }

        /* Status Cards */
        .status-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }
        #statusBadge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .sos-btn { background: var(--nasa-red); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; box-shadow: 0 0 15px rgba(252,61,33,0.3); }
        .sos-btn:hover { transform: scale(1.02); background: #ff4d36; }

        /* Chatbot Interface */
        .chat-launcher { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--nasa-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2001; border: 2px solid white; font-size: 28px; box-shadow: 0 0 20px var(--nasa-blue); }
        .chat-window { position: fixed; bottom: 110px; right: 30px; width: 420px; height: 550px; background: #0d1117; border: 1px solid var(--nasa-blue); border-radius: 20px; display: none; flex-direction: column; z-index: 2000; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.8); }
        .chat-header { background: var(--nasa-blue); padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-content { display: flex; height: calc(100% - 50px); }
        .cat-panel { width: 38%; background: #161b22; padding: 10px; overflow-y: auto; border-right: 1px solid #30363d; }
        .chat-main { width: 62%; display: flex; flex-direction: column; background: #0d1117; }
        .chat-display { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; scroll-behavior: smooth; }
        .q-area { height: 150px; overflow-y: auto; background: #161b22; padding: 8px; border-top: 1px solid #30363d; }
        
        .cat-item { padding: 8px; margin-bottom: 6px; background: #21262d; border-radius: 8px; cursor: pointer; font-size: 11px; text-align: center; transition: 0.2s; border: 1px solid transparent; }
        .cat-item:hover { border-color: var(--neon-blue); background: #30363d; }
        .q-item { padding: 6px; background: #30363d; margin-bottom: 5px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .q-item:hover { background: var(--nasa-blue); }
        
        .msg { margin-bottom: 12px; padding: 10px; border-radius: 12px; max-width: 85%; line-height: 1.4; font-size: 13px; }
        .bot { background: #238636; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .user { background: var(--nasa-blue); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
    </style>
</head>
<body>

<div class="search-box">
    <input type="text" id="cityInput" placeholder="Enter City or Country...">
    <button onclick="searchLocation()">Search</button>
</div>

<div class="layer-control">
    <button onclick="setLayer('street')">Street View</button>
    <button onclick="setLayer('sat')">Satellite</button>
    <button onclick="toggleClouds()">Cloud Layer</button>
</div>

<div class="dashboard-container">
    <div class="sidebar">
        <div style="display:flex; align-items:center; gap:12px; padding-bottom:15px; border-bottom:1px solid #30363d;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/NASA_logo.svg" width="45">
            <h2 style="font-size:18px; letter-spacing:1px; margin:0;">SENTINEL PRO</h2>
        </div>

        <div class="status-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:11px; color:#8b949e;">SAT-LINK</span>
                <span id="statusBadge" style="background:#238636;">STABLE</span>
            </div>
            <p id="aiOutput" style="font-size:12px; margin-top:12px; color:#c9d1d9;">Awaiting satellite handshake...</p>
        </div>

        <div class="status-card">
            <span style="font-size:11px; color:#8b949e;">RAIN PREDICTION (24H)</span>
            <canvas id="rainChart" style="margin-top:10px;"></canvas>
        </div>

        <button class="sos-btn" onclick="triggerSOS()">ðŸš¨ DMC EMERGENCY SOS</button>
        
        <div style="margin-top:auto; font-size:10px; color:#484f58; text-align:center;">
            NASA GIBS v4.2 Protocol<br>
            Developer: <b style="color:var(--neon-blue);">DISAS DINSITHA</b>
        </div>
    </div>

    <div id="map"></div>
</div>

<div class="chat-launcher" onclick="toggleChat()">ðŸ¤–</div>
<div class="chat-window" id="chatWin">
    <div class="chat-header">
        <span>Sentinel Knowledge Base</span>
        <span onclick="toggleChat()" style="cursor:pointer; font-size:24px;">&times;</span>
    </div>
    <div class="chat-content">
        <div class="cat-panel" id="catPanel"></div>
        <div class="chat-main">
            <div class="chat-display" id="chatDisplay"></div>
            <div class="q-area" id="qArea"></div>
        </div>
    </div>
</div>

<script>
    // --- INTEGRATED KNOWLEDGE BASE ---
    const chatData = {
        "Atmosphere": [
            ["What is the Troposphere?", "The lowest layer of Earth's atmosphere where all weather occurs."],
            ["What is air pressure?", "The weight of the atmosphere pressing down on the earth."],
            ["What is humidity?", "The amount of water vapor present in the air."],
            ["What is wind?", "The movement of air from high pressure to low pressure areas."],
            ["What is the ozone layer?", "A region in the stratosphere that absorbs most of the sun's UV radiation."]
        ],
        "Flood Science": [
            ["What is a Flash Flood?", "A sudden, violent flood that happens within hours of heavy rain."],
            ["What is a Levee?", "An embankment built to prevent the overflow of a river."],
            ["What is saturation?", "When the ground cannot absorb any more water, leading to runoff."],
            ["Define a watershed.", "An area of land where all water drains into the same place."]
        ],
        "NASA Tech": [
            ["What is Sentinel-2?", "NASA/ESA satellites that provide high-resolution imagery for land monitoring."],
            ["What is SAR?", "Synthetic Aperture Radar; it can see through clouds to map floods."],
            ["What is Satellite View?", "Real-time imagery from orbit using optical sensors."],
            ["What is Landsat?", "A series of satellites providing the longest continuous space-based record of Earth's land."]
        ],
        "Safety & DMC": [
            ["Emergency Kit?", "A box with water, dry food, a torch, and a first aid kit."],
            ["What is the 117 hotline?", "The emergency number for the Disaster Management Center in Sri Lanka."],
            ["Flood safety rule #1?", "Never walk or drive through moving water."]
        ],
        "Climate Change": [
            ["Global Warming?", "The long-term heating of Earth's climate system due to human activities."],
            ["Greenhouse Effect?", "Gases trapping heat in the atmosphere, keeping Earth warm."],
            ["Why are floods increasing?", "Warmer air holds more moisture, leading to heavier rain."]
        ]
    };

    let map, marker, rainChart, cloudLayer;
    let layers = {
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
        sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
    };

    // --- MAP CORE ---
    function initMap(lat, lon) {
        map = L.map('map', { zoomControl: false }).setView([lat, lon], 12);
        layers.sat.addTo(map); // Start with Satellite for NASA feel

        // OpenWeather Cloud Layer
        cloudLayer = L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=d22d9a2885474c15e87a2d48083884d5');

        marker = L.marker([lat, lon]).addTo(map).bindPopup("Sentinel Active Station").openPopup();
        map.flyTo([lat, lon], 13, { duration: 2.5 });
        updateData(lat, lon);
    }

    function setLayer(type) {
        map.removeLayer(layers.street);
        map.removeLayer(layers.sat);
        layers[type].addTo(map);
    }

    function toggleClouds() {
        if(map.hasLayer(cloudLayer)) map.removeLayer(cloudLayer);
        else cloudLayer.addTo(map);
    }

    async function searchLocation() {
        const query = document.getElementById('cityInput').value;
        if(!query) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
        const data = await res.json();
        if(data[0]) {
            const { lat, lon } = data[0];
            map.flyTo([lat, lon], 14, { animate: true, duration: 2 });
            marker.setLatLng([lat, lon]);
            updateData(lat, lon);
        }
    }

    async function updateData(lat, lon) {
        const aiOutput = document.getElementById('aiOutput');
        aiOutput.innerText = "Analyzing coordinates: " + parseFloat(lat).toFixed(3) + " / " + parseFloat(lon).toFixed(3);
        
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=rain&forecast_days=1`);
        const data = await res.json();
        const rain = data.hourly.rain.slice(0, 24);
        updateChart(rain);
    }

    function updateChart(rainData) {
        const ctx = document.getElementById('rainChart').getContext('2d');
        if(rainChart) rainChart.destroy();
        rainChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: Array.from({length: 24}, (_, i) => i + "h"), 
                datasets: [{ data: rainData, borderColor: '#00d4ff', borderWidth: 2, fill: true, backgroundColor: 'rgba(0,212,255,0.1)', tension: 0.4 }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#484f58', font: {size: 9} } } } }
        });
    }

    // --- CHATBOT CORE ---
    function toggleChat() {
        const win = document.getElementById('chatWin');
        win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        if(win.style.display === 'flex' && !document.getElementById('catPanel').innerHTML) loadCategories();
    }

    function loadCategories() {
        const cp = document.getElementById('catPanel');
        for(let cat in chatData) {
            const div = document.createElement('div');
            div.className = 'cat-item';
            div.innerText = cat;
            div.onclick = () => loadQuestions(cat);
            cp.appendChild(div);
        }
        addMsg("bot", "Welcome to Sentinel Knowledge Base. Select a category to start.");
    }

    function loadQuestions(cat) {
        const qa = document.getElementById('qArea');
        qa.innerHTML = "";
        addMsg("bot", "Now exploring: " + cat);
        chatData[cat].forEach(p => {
            const div = document.createElement('div');
            div.className = 'q-item';
            div.innerText = p[0];
            div.onclick = () => {
                addMsg("user", p[0]);
                setTimeout(() => addMsg("bot", p[1]), 400);
            };
            qa.appendChild(div);
        });
    }

    function addMsg(type, text) {
        const display = document.getElementById('chatDisplay');
        const d = document.createElement('div');
        d.className = 'msg ' + type;
        d.innerText = text;
        display.appendChild(d);
        display.scrollTop = display.scrollHeight;
    }

    function triggerSOS() {
        alert("ðŸš¨ EMERGENCY: SOS Signal transmitted to NASA Sentinel & Disaster Management Center.");
    }

    // Initialize
    navigator.geolocation.getCurrentPosition(p => {
        initMap(p.coords.latitude, p.coords.longitude);
    }, () => initMap(6.9271, 79.8612));
</script>
</body>
</html>